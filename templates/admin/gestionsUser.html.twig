{% extends 'base.html.twig' %}

{% block title %}
	Gestions des Utilisateurs | Eléctro-Multifix
{% endblock %}

{% block body %}

	{% include 'admin/_menu.html.twig' %}


	<div class="my-3 text-center">
		<h2>Gestions des Utilisateurs</h2>
	</div>


	<div class="container">
		<div class="row my-5">
			{% for type, messages in app.flashes %}
				{% for message in messages %}
					<div class="alert alert-{{ type }} alert-dismissible fade show" role="alert">
						{{ message }}
						<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
					</div>
				{% endfor %}
			{% endfor %}


			<div class="row">

				<div class="col-12 col-md-6">
					<div class="col-12 d-flex justify-content-center">
						<div class="card border border-primary">
							<div class="card-header">
								<h5 class="text-center">Enregistrer un Utilisateur</h5>
							</div>

							<div class="card-body">
								{{form_start(form)}}
								<div class="row">
									<div class="col-12 col-md-6">
										{{form_row(form.nom)}}
									</div>

									<div class="col-12 col-md-6">
										{{form_row(form.password)}}
									</div>
								</div>
								<div class="row">
									<div class="col-12">
										{{form_row(form.email)}}
									</div>
								</div>
								<div class="row">
									<div class="col-12 col-md-6">
										{{form_row(form.phone)}}
									</div>

									<div class="col-12 col-md-6">
										<label for="role">Choisisez une Role :</label>
										<select name="fonction" class="form-control border border-primary mt-2" id="role">
											<option value="ROLE_CLIENT">Client</option>
											<option value="ROLE_EMPLOYER">Employer</option>
											<option value="ROLE_ADMIN">Administrateur</option>
										</select>
									</div>
								</div>

								<div class="row">
									<div class="col-12">
										{{form_row(form.adresse)}}
									</div>
								</div>


								<input type="submit" value="Enregistrer" class="btn btn-success">
								{{form_end(form)}}
							</div>
						</div>
					</div>
				</div>

				<div class="col-12 col-md-6">
					<div class="container mt-5">
						<h6 class="mb-4 text-center">Statistiques des clients selon leurs achats</h6>
						<div class="table-responsive">
							<table class="table table-striped">
								<thead class="text-center">
									<tr>
										<th>#</th>
										<th>Nom d'utilisateur</th>
										<th>Nombre de produits achetés</th>
									</tr>
								</thead>
								<tbody class="text-center">
									{% for user in userStats %}
										<tr>
											<td>{{ loop.index }}</td>
											<td>
												<a href="{{path('admin_voir_user',{'matricule': user.user_matricule,'id':user.user_id})}}">{{ user.user_nom }}</a>
											</td>
											<td>{{ user.order_count }}</td>
										</tr>
									{% else %}
										<tr>
											<td colspan="3" class="text-center">Aucune donnée disponible</td>
										</tr>
									{% endfor %}
								</tbody>
							</table>


						</div>

						<div class="mt-3">
							<h6 class="mb-4 text-center">Statistiques des clients selon leurs nombres des reparations</h6>
							<div class="table-responsive">
								{% if statistiqueRepa is empty %}
									<p class="text-center text-danger">Aucune Données.</p>
								{% else %}
									<table class="table table-hover table-striped text-center">
										<thead class="table-light">
											<tr>
												<th>#</th>
												<th>Nom d'utilisateur</th>
												<th>Nombre de Réparations</th>
											</tr>
										</thead>
										<tbody>

											{% for stat in statistiqueRepa %}
												<tr>
													<td>{{ loop.index }}</td>
													<td>
														<a href="{{path('admin_voir_user',{'matricule':stat.matricule,'id':stat.id})}}">{{ stat.nom }}</a>
													</td>
													<td>{{ stat.reparationCount }}</td>
												</tr>

											{% endfor %}
										</tbody>
									</table>
								{% endif %}
							</div>
						</div>
					</div>

				</div>

				<h1 class="text-center mt-3">Liste des utilisateurs</h1>
				<!-- Formulaire de recherche -->
				<form method="get" class="my-4">
					<div class="row">
						<div class="col-md-4">
							<input type="text" name="nom" class="form-control border border-dark" placeholder="Nom" value="{{ filters.nom }}">
						</div>
						<div class="col-md-4">
							<input type="text" name="phone" class="form-control border border-dark" placeholder="Téléphone" value="{{ filters.phone }}">
						</div>
						<div class="col-md-4">
							<select name="fonction" class="form-control border border-dark">
								<option value="">-- Fonction --</option>
								<option value="ROLE_ADMIN" {{ filters.fonction == 'ROLE_ADMIN' ? 'selected' : '' }}>Admin</option>
								<option value="ROLE_CLIENT" {{ filters.fonction == 'ROLE_CLIENT' ? 'selected' : '' }}>Client</option>
								<option value="ROLE_EMPLOYER" {{ filters.fonction == 'ROLE_EMPLOYER' ? 'selected' : '' }}>Employé</option>
							</select>
						</div>
					</div>
					<div class="mt-3 text-center">
						<button type="submit" class="btn btn-primary">Rechercher</button>
					</div>
				</form>

				<div class="table-responsive my-3">
					<div class="count">
						{{ users.getTotalItemCount }}
						Utilisateurs inscrit.
					</div>
					<table class="table table-hover rounded">
						<thead class="text-center table-warning">
							<tr>
								<th>Nom</th>
								<th>Télèlphone</th>
								<th>Fonction</th>
								<th>Nbr commandes</th>
								<th>Nbr réparations</th>
								<th>Status Compte</th>
								<th colspan="3">Action</th>
							</tr>
						</thead>

						<tbody class="text-center">
							{% if users is empty %}
								<div class="alert alert-info">
									<p>Aucun Utilisateur crée.</p>
								</div>
							{% else %}
								{% for user in users %}
									<tr class="align-middle">
										<td class="text-center align-middle">{{user.nom}}</td>
										<td class="text-center align-middle">{{user.phone}}</td>
										<td class="text-center align-middle">
											{% if user.fonction == "ROLE_ADMIN" %}
												<span class="badge bg-info">Administrateur</span>
											{% elseif user.fonction =="ROLE_CLIENT" %}
												<span class="badge bg-info">Client</span>
											{% elseif user.fonction== "ROLE_EMPLOYER" %}
												<span class="badge bg-info">Employer</span>
											{% endif %}
										</td>
										<td class="text-center align-middle">{{user.commandesCount}}</td>
										<td class="text-center align-middle">{{user.reparationsCount}}</td>
										<td class="text-center align-middle">

											<label class="form-switch">
												<input type="checkbox" role="switch" {{(user.statuscompte) ? 'checked' : ''}} data-id="{{user.id}}">
											</label>

										</td>
										<td class="text-center align-middle ">
											<form action="{{ path('admin_user_supp', {'id': user.id}) }}" method="post" onsubmit="return confirm('Confirmer la suppression de l'utilisateur ?');" class="d-inline">
												<input type="hidden" name="_token" value="{{ csrf_token('SUP' ~ user.id) }}">
												<button type="submit" class="btn btn-danger">
													<i class="fa-regular fa-trash-can"></i>
												</button>
											</form>
											<a href="{{path('admin_user_modifi',{'id':user.id})}}" class="btn btn-warning">
												<i class="fa-regular fa-pen-to-square"></i>
											</a>

											<a href="{{path('admin_voir_user',{'matricule':user.matricule,'id':user.id})}}" class="btn btn-info">
												<i class="fa-solid fa-eye"></i>
											</a>

										</td>
									</tr>
								{% endfor %}
							</tbody>


						{% endif %}
					</table>

					<div class="pagination">
						{{ knp_pagination_render(users) }}
					</div>
				</div>

			</div>
		</div>


		<script>
			window.onload = () => {
let activer = document.querySelectorAll("[type=checkbox]")
for (let bouton of activer) {
bouton.addEventListener("click", function () {
let xmlhttp = new XMLHttpRequest;
xmlhttp.open("get", `/admin/user/activer/${
this.dataset.id
}`)
xmlhttp.send()
})
}
}
		</script>

	{% endblock %}
